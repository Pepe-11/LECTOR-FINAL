<!DOCTYPE html>
<html>
<head><title>Acceso NFC</title></head>
<body>
    <div id="app">
        <p id="msg">Cargando...</p>
        <div id="loginForm" style="display:none;">
            <input type="text" id="user" placeholder="Usuario"><br>
            <input type="password" id="pass" placeholder="Contraseña"><br>
            <button onclick="doLogin()">Entrar</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('t');
        const scriptUrl = "https://script.google.com/macros/s/AKfycby4Xkkw7ZYZAIyEkY8qUKQITiXC8to1eAOU1OWYpbvJhVuCGkMXjgYf5AFPjDHQvvjDxg/exec";

        // Al cargar, verificamos si el token es válido
        fetch(`${scriptUrl}?t=${token}`)
            .then(r => r.text())
            .then(res => {
                if (res === "VALIDO") {
                    document.getElementById("msg").innerHTML = "<h1>Bienvenido. Acceso concedido.</h1>";
                } else {
                    document.getElementById("msg").innerText = "Sesión nueva o expirada. Inicie sesión:";
                    document.getElementById("loginForm").style.display = "block";
                }
            });

        function doLogin() {
            const u = document.getElementById("user").value;
            const p = document.getElementById("pass").value;
            fetch(`${scriptUrl}?action=login&t=${token}&u=${u}&p=${p}`)
                .then(r => r.text())
                .then(res => {
                    if (res === "LOGIN_OK") {
                        location.reload(); // Recarga para validar la sesión ahora activa
                    } else {
                        alert("Credenciales incorrectas");
                    }
                });
        }
    </script>
</body>
</html>
