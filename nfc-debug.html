<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector NFC - Debug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        #output {
            margin-top: 30px;
            padding: 20px;
            background: #f7f7f7;
            border-radius: 10px;
            min-height: 100px;
            text-align: left;
            font-size: 14px;
            line-height: 1.6;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status.waiting {
            background: #ffeaa7;
            color: #d63031;
        }

        .status.reading {
            background: #74b9ff;
            color: #0984e3;
        }

        .status.success {
            background: #55efc4;
            color: #00b894;
        }

        .status.error {
            background: #ff7675;
            color: #d63031;
        }

        .card-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .card-info h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .card-info p {
            margin: 8px 0;
            color: #555;
        }

        .debug-log {
            background: #2d2d2d;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            margin-top: 15px;
        }

        .debug-log p {
            margin: 5px 0;
            color: #00ff00;
        }

        .debug-log .error {
            color: #ff6b6b;
        }

        .debug-log .warning {
            color: #ffd93d;
        }

        .debug-log .info {
            color: #6bcfff;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .scanning {
            animation: pulse 1.5s infinite;
        }

        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Lector NFC - Debug Mode</h1>
        <p class="subtitle">Versi√≥n con diagn√≥stico detallado</p>

        <div>
            <button id="read-nfc">üîç Leer NFC</button>
            <button id="clear-log" class="btn-secondary">üóëÔ∏è Limpiar Log</button>
        </div>
        
        <div id="output">
            <span class="status waiting">‚è≥ Esperando...</span>
            <p>Presiona "Leer NFC" para comenzar el diagn√≥stico</p>
        </div>

        <div id="debug-log" class="debug-log" style="display: none;">
            <p><strong>üìã LOG DE DIAGN√ìSTICO:</strong></p>
        </div>
    </div>

    <script>
        const readButton = document.getElementById('read-nfc');
        const clearButton = document.getElementById('clear-log');
        const output = document.getElementById('output');
        const debugLog = document.getElementById('debug-log');

        let logMessages = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push({ text: logEntry, type });
            
            debugLog.style.display = 'block';
            debugLog.innerHTML = '<p><strong>üìã LOG DE DIAGN√ìSTICO:</strong></p>';
            
            logMessages.forEach(log => {
                const p = document.createElement('p');
                p.className = log.type;
                p.textContent = log.text;
                debugLog.appendChild(p);
            });

            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logEntry);
        }

        clearButton.addEventListener('click', () => {
            logMessages = [];
            debugLog.style.display = 'none';
            output.innerHTML = `
                <span class="status waiting">‚è≥ Log limpiado</span>
                <p>Presiona "Leer NFC" para comenzar</p>
            `;
        });

        readButton.addEventListener('click', async () => {
            addLog('üöÄ Iniciando proceso de lectura NFC...', 'info');

            // Verificar soporte de NDEFReader
            if (!('NDEFReader' in window)) {
                addLog('‚ùå NDEFReader no encontrado en window', 'error');
                output.innerHTML = `
                    <span class="status error">‚ùå Web NFC no soportado</span>
                    <p><strong>Tu navegador no soporta Web NFC API.</strong></p>
                    <p style="margin-top: 10px;">Requisitos:</p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Chrome 89+ en Android</li>
                        <li>HTTPS (o localhost)</li>
                        <li>NFC activado en el dispositivo</li>
                    </ul>
                `;
                return;
            }

            addLog('‚úÖ NDEFReader est√° disponible', 'info');

            try {
                const ndef = new NDEFReader();
                addLog('‚úÖ Instancia de NDEFReader creada', 'info');
                
                output.innerHTML = `
                    <span class="status reading scanning">üîç Escaneando...</span>
                    <p><strong>Acerca tu tarjeta NFC al tel√©fono</strong></p>
                    <p style="margin-top: 10px; font-size: 13px; color: #666;">
                        ‚Ä¢ Mant√©n la tarjeta cerca 2-3 segundos<br>
                        ‚Ä¢ Por la parte trasera del tel√©fono<br>
                        ‚Ä¢ No muevas la tarjeta mientras lee
                    </p>
                `;
                
                readButton.disabled = true;
                addLog('üîÑ Solicitando permisos y comenzando scan...', 'info');

                // Iniciar el escaneo
                await ndef.scan();
                addLog('‚úÖ Scan iniciado correctamente', 'info');

                // Listener para cuando se detecta un tag
                ndef.addEventListener("reading", ({ message, serialNumber }) => {
                    addLog('üéâ ¬°TAG NFC DETECTADO!', 'info');
                    addLog(`üìá Serial Number: ${serialNumber}`, 'info');
                    addLog(`üìä Cantidad de records: ${message.records.length}`, 'info');

                    let cardData = {
                        id: serialNumber,
                        records: []
                    };

                    // Procesar cada record
                    message.records.forEach((record, index) => {
                        addLog(`üìù Procesando record ${index + 1}...`, 'info');
                        addLog(`   - recordType: ${record.recordType}`, 'info');
                        addLog(`   - mediaType: ${record.mediaType}`, 'info');
                        addLog(`   - id: ${record.id}`, 'info');

                        let recordData = {
                            recordType: record.recordType,
                            mediaType: record.mediaType,
                            id: record.id,
                            data: null,
                            rawData: null
                        };

                        try {
                            // Intentar decodificar seg√∫n el tipo
                            if (record.recordType === "text") {
                                addLog(`   ‚ÑπÔ∏è Decodificando como TEXT...`, 'info');
                                const textDecoder = new TextDecoder(record.encoding || 'utf-8');
                                recordData.data = textDecoder.decode(record.data);
                                addLog(`   ‚úÖ Texto decodificado: "${recordData.data}"`, 'info');
                            } else if (record.recordType === "url") {
                                addLog(`   ‚ÑπÔ∏è Decodificando como URL...`, 'info');
                                const textDecoder = new TextDecoder();
                                recordData.data = textDecoder.decode(record.data);
                                addLog(`   ‚úÖ URL decodificada: "${recordData.data}"`, 'info');
                            } else {
                                addLog(`   ‚ö†Ô∏è Tipo desconocido, mostrando en HEX`, 'warning');
                                const dataView = new DataView(record.data.buffer);
                                let hex = '';
                                for (let i = 0; i < dataView.byteLength; i++) {
                                    hex += dataView.getUint8(i).toString(16).padStart(2, '0') + ' ';
                                }
                                recordData.data = hex.trim();
                                addLog(`   üìä Datos HEX: ${recordData.data}`, 'info');
                            }

                            // Guardar raw data como backup
                            const rawBytes = new Uint8Array(record.data.buffer);
                            recordData.rawData = Array.from(rawBytes).map(b => 
                                b.toString(16).padStart(2, '0')
                            ).join(' ');

                        } catch (error) {
                            addLog(`   ‚ùå Error decodificando: ${error.message}`, 'error');
                            recordData.data = `Error: ${error.message}`;
                        }

                        cardData.records.push(recordData);
                    });

                    addLog('‚úÖ Procesamiento completado', 'info');
                    displayCardInfo(cardData);
                    readButton.disabled = false;
                });

                // Listener para errores de lectura
                ndef.addEventListener("readingerror", (error) => {
                    addLog(`‚ùå ERROR DE LECTURA: ${error}`, 'error');
                    output.innerHTML = `
                        <span class="status error">‚ö†Ô∏è Error de Lectura</span>
                        <p>No se pudo leer la tarjeta NFC.</p>
                        <p style="margin-top: 10px;"><strong>Intenta:</strong></p>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Acercar m√°s la tarjeta al tel√©fono</li>
                            <li>Mantenerla completamente quieta 2-3 segundos</li>
                            <li>Verificar que NFC est√© activado</li>
                            <li>Probar con otra tarjeta NFC</li>
                        </ul>
                    `;
                    readButton.disabled = false;
                });

            } catch (error) {
                addLog(`‚ùå ERROR CR√çTICO: ${error.name}`, 'error');
                addLog(`   Mensaje: ${error.message}`, 'error');
                
                output.innerHTML = `
                    <span class="status error">‚ùå Error</span>
                    <p><strong>Error:</strong> ${error.name}</p>
                    <p><strong>Mensaje:</strong> ${error.message}</p>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; text-align: left;">
                        <strong>üí° Posibles soluciones:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li><strong>NotAllowedError:</strong> Debes dar permisos a Chrome para usar NFC</li>
                            <li><strong>NotSupportedError:</strong> Tu dispositivo no soporta NFC</li>
                            <li><strong>NotReadableError:</strong> NFC est√° desactivado en Configuraci√≥n</li>
                            <li><strong>InvalidStateError:</strong> Ya hay un escaneo activo</li>
                        </ul>
                    </div>

                    <p style="margin-top: 15px; font-size: 13px;">
                        <strong>Verifica:</strong><br>
                        ‚Ä¢ NFC activado (Configuraci√≥n ‚Üí Conexiones ‚Üí NFC)<br>
                        ‚Ä¢ Permisos dados a Chrome<br>
                        ‚Ä¢ HTTPS en la URL (o localhost)<br>
                        ‚Ä¢ Chrome versi√≥n 89 o superior
                    </p>
                `;
                readButton.disabled = false;
            }
        });

        function displayCardInfo(cardData) {
            let html = `
                <span class="status success">‚úÖ ¬°Lectura Exitosa!</span>
                <div class="card-info">
                    <h3>üìá Informaci√≥n de la Tarjeta NFC</h3>
                    
                    <p><strong>üÜî ID (Serial Number):</strong></p>
                    <code style="display: block; padding: 8px; margin-top: 5px;">
                        ${cardData.id || 'No disponible'}
                    </code>
            `;

            if (cardData.records.length > 0) {
                html += `
                    <p style="margin-top: 15px;"><strong>üìÑ Registros NDEF:</strong> ${cardData.records.length}</p>
                `;
                
                cardData.records.forEach((record, index) => {
                    html += `
                        <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #667eea;">
                            <p style="margin-bottom: 8px;"><strong>üìù Registro ${index + 1}</strong></p>
                            
                            <div style="font-size: 13px;">
                                <p><strong>Tipo:</strong> <code>${record.recordType}</code></p>
                                
                                ${record.mediaType ? `<p><strong>Media Type:</strong> <code>${record.mediaType}</code></p>` : ''}
                                
                                ${record.id ? `<p><strong>ID:</strong> <code>${record.id}</code></p>` : ''}
                                
                                <p style="margin-top: 8px;"><strong>Contenido:</strong></p>
                                <code style="display: block; padding: 8px; margin-top: 5px; background: white; word-break: break-all;">
                                    ${record.data || 'Sin datos'}
                                </code>

                                ${record.rawData ? `
                                    <p style="margin-top: 8px;"><strong>Raw Data (HEX):</strong></p>
                                    <code style="display: block; padding: 8px; margin-top: 5px; background: white; font-size: 10px; word-break: break-all;">
                                        ${record.rawData}
                                    </code>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px;">
                        <p style="color: #856404;">
                            ‚ö†Ô∏è <strong>No se encontraron registros NDEF</strong>
                        </p>
                        <p style="font-size: 12px; margin-top: 5px; color: #856404;">
                            La tarjeta tiene ID pero no contiene datos NDEF (texto/URL). 
                            Esto es normal en tarjetas vac√≠as o de tipo no-NDEF.
                        </p>
                    </div>
                `;
            }

            html += `
                    <div style="margin-top: 20px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 12px;">
                        <p>üí° <strong>Tip:</strong> El ID de la tarjeta es √∫nico y siempre se puede leer, 
                        incluso si la tarjeta no tiene datos NDEF almacenados.</p>
                    </div>
                </div>
            `;

            output.innerHTML = html;
            addLog('üé® UI actualizada con la informaci√≥n de la tarjeta', 'info');
        }

        // Log inicial
        addLog('‚öôÔ∏è Sistema inicializado', 'info');
        addLog(`üì± User Agent: ${navigator.userAgent}`, 'info');
        addLog(`üîí Protocolo: ${window.location.protocol}`, 'info');
        addLog(`üåê URL: ${window.location.href}`, 'info');
    </script>
</body>
</html>
